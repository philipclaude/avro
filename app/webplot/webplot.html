<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE HTML PUBLIC "~//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">

<html id="mainBody">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <!-- needed for collapsing -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.0/js/bootstrap.min.js"></script>

    <title>
      webplot
    </title>

    <link rel="shortcut icon" href="favicon.ico">

    <script type="text/javascript" src="../WebViewer/webgl-utils.js"> </script>
    <script type="text/javascript" src="../WebViewer/webgl-debug.js"> </script>
    <script type="text/javascript" src="../WebViewer/J3DIMath.js">    </script>

    <script>
      var   wv   = {};            // object to store "globals"
      var   listener = {};
      var   elemsizes = {};
    </script>
    <script type="text/javascript" src="../WebViewer/wv-draw.js">     </script>
    <script type="text/javascript" src="../WebViewer/wv-render.js">   </script>
    <script type="text/javascript" src="../WebViewer/wv-gPrim.js">    </script>
    <script type="text/javascript" src="../WebViewer/wv-sGraph.js">   </script>
    <script type="text/javascript" src="../WebViewer/wv-socket.js">   </script>
    <script type="text/javascript" src="../WebViewer/wv-cbManage.js"> </script>

    <script type="text/javascript" src="avro.js"> </script>
    <script type="text/javascript" src="viewer.js"> </script>
    <script type="text/javascript" src="tree.js"> </script>
    <script type="text/javascript" src="terminal.js"> </script>
    <script type="text/javascript" src="listener.js"> </script>

    <script type="text/javascript">
      getSocketsURL = function(url)
      {
        // set our callback functions
        var url = prompt("Enter hostname:port", "ws://hypersonic.mit.edu:7681");
        wv.getSockets(url);
        wv.setCallback("InitUI",        wvInitUI);
        wv.setCallback("UpdateUI",      wvUpdateUI);
        wv.setCallback("ServerMessage", wvServerMessage);
        wv.setCallback("UpdateCanvas",  wvUpdateCanvas);
        wv.setCallback("OnOpen",wvClientConnected);
        wv.Start();
        postMessage("connected to "+url+"!","green");
        wv.url = url;
      }
      reconnectSocketsURL = function()
      {
        // set our callback functions
        var url = wv.url;
        wv.getSockets(url);
        wv.setCallback("InitUI",        wvInitUI);
        wv.setCallback("UpdateUI",      wvUpdateUI);
        wv.setCallback("ServerMessage", wvServerMessage);
        wv.setCallback("UpdateCanvas",  wvUpdateCanvas);
        wv.setCallback("OnOpen",wvClientConnected);
        wv.Start();
      }
    </script>

    <script>
      "use strict";

      wv.zNear    =  1.0;           // have some values for Zscreen
      wv.zFar     = 11.0;
      wv.canvasID = "WebViewer";    // must match canvas id=... below

      wv.mode4d = false;
      wv.colorbar = undefined;
      wv.colorbarlims = new Float32Array(2);

      // initialize websockets
      wv.getSockets("ws://Localhost:7681");

      wv.setCallback("InitUI",        wvInitUI);
      wv.setCallback("UpdateUI",      wvUpdateUI);
      wv.setCallback("ServerMessage", wvServerMessage);
      wv.setCallback("UpdateCanvas",  wvUpdateCanvas);
      wv.setCallback("OnOpen",wvClientConnected);
      var myTree = new Tree(document,"myTree");

    </script>

    <!-- save file function -->
    <script type="text/javascript">
      saveFile = function(e)
      {
        postMessage("saving file");
        var canvas = document.getElementById("WebViewer");
        var image = canvas.toDataURL("image/png",1);
        console.log(image);
        var dlLink = document.createElement('a');
        dlLink.download = "avro.png";
        dlLink.href = image;
        dlLink.dataset.dowloadurl = ["image/png",dlLink.download,dlLink.href].join(':');
        document.body.appendChild(dlLink);
        dlLink.click();
        document.body.removeChild(dlLink);
      }
    </script>

    <!-- toggle canvas darkness function -->
    <script type="text/javascript">
      toggleDarkness = function(e)
      {
        var cbox = document.getElementById("cboxDark");
        var canvas = document.getElementById("WebViewer");
        if (cbox.checked)
          canvas.style.background = 'black';
        else
          canvas.style.background = '#585C5C';
      }

      changeColormap = function()
      {
        var value = document.getElementById('colormapSelect').value;
        postMessage("change colormap to "+value+" !","blue");
        wv.socketUt.send("colormap|"+value);
        if (wv.colorbar!=undefined)
          wv.socketUt.send("getcolorbar|10");
      }

      toggleColorbar = function()
      {
        var box = document.getElementById('showcolorbar');
        if (box.checked)
          wv.socketUt.send("getcolorbar|10"); // ask for 10 values
        else
          wv.colorbar = undefined;
      }

      loadTree = function()
      {
        wv.socketUt.send("getTree|");
      }

      sliceRequest = function()
      {
        // get the values in the 4d controls boxes
        var d = Number(document.getElementById('control4d-distance').value);
        var plane = document.getElementById('hyperplaneSelect').value;

        /*
        var axy = Number(document.getElementById('control4d-angleXY').value);
        var axz = Number(document.getElementById('control4d-angleXZ').value);
        var axt = Number(document.getElementById('control4d-angleXT').value);
        var ayz = Number(document.getElementById('control4d-angleYZ').value);
        var ayt = Number(document.getElementById('control4d-angleYT').value);
        var azt = Number(document.getElementById('control4d-angleZT').value);

        // send the message to the server
        var reply = "slice4d|{ \"values\": "
                      +JSON.stringify([axy,axz,axt,ayz,ayt,azt,d]);
        if (document.getElementById('experimental-4d').checked)
        {
          reply += "}";
          postMessage("sorry experimental rotations disabled until editGPrim with more stripes is implemented!");
        }
        */
        var reply = "slice4d|"+plane+"|"+d.toString();
        clearPlots();
        wv.socketUt.send(reply);
        alert('please wait for the server to finish\nand re-load the plot tree!');
      }

      resetSlice = function()
      {
        document.getElementById('control4d-distance').value = 0;
        document.getElementById('control4d-angleXY').value = 0;
        document.getElementById('control4d-angleXZ').value = 0;
        document.getElementById('control4d-angleXT').value = 0;
        document.getElementById('control4d-angleYZ').value = 0;
        document.getElementById('control4d-angleYT').value = 0;
        document.getElementById('control4d-angleZT').value = 0;
        sliceRequest();
      }
    </script>

    <link rel="stylesheet" type="text/css" href="avro.css" />

  </head>
    <body onload=wv.Start();resizeFrames();listener.initialize();>
      <div id="tlframe" oncontextmenu="return false;">
        <div id="butnfrm" oncontextmenu="return false;">
          <h6 align="center">
          avro webplot
        </h6>
          <!-- viewer control buttons -->
          <p align="center">
            <button title="Home (front) view"      type="button" id="homeButton"  onclick="cmdHome()">H          </button>
            <button title="Left side view"         type="button" id="leftButton"  onclick="cmdLeft()">L          </button>
            <button title="Right side view"        type="button" id="riteButton"  onclick="cmdRite()">R          </button>
            <button title="Bottom view"            type="button" id="botmButton"  onclick="cmdBotm()">B          </button>
            <button title="Top view"               type="button" id="topButton"   onclick="cmdTop()" >T          </button>
            <button title="Zoom in"                type="button" id="inButton"    onclick="cmdIn()"  >+          </button>
            <button title="Zoom out"               type="button" id="outButton"   onclick="cmdOut()" >-          </button>
            <button title="Connect WebSocket"      type="button" id="getSocketsURL"   onclick="getSocketsURL()" >WS         </button>
            <button title="Reconnect"      type="button" id="reconnectSocketsURL"   onclick="reconnectSocketsURL()" >&#8634;         </button>
          </p>

        <div class="panel-group" id="accordion">
         <div class="panel panel-default">
           <div class="panel-heading">
               <a data-toggle="collapse" data-parent="#accordion" href="#collapse1">
               File</a>
           </div>
           <div id="collapse1" class="panel-collapse collapse">
             <div class="panel-body">
                 <button title="dirUp" type="button" id="dirUpLevel" onclick="rollbackDirectory()">&#x21D0;</button>
                 <select name="Files" id="directory" onchange="addPlot()"></select>
                 <button title="save" type="button" id="save" onclick="saveFile()">PNG</button>
            </div>
           </div>
         </div>

         <!-- colours -->
         <div class="panel panel-default">
           <div class="panel-heading">
               <a data-toggle="collapse" data-parent="#accordion" href="#collapse2">
               Colours</a>
           </div>
           <div id="collapse2" class="panel-collapse collapse">
             <div class="panel-body">
               colormap:
               <select name="colormap" id="colormapSelect" value="viridis" onchange="changeColormap()">
                 <option value="viridis" selected="selected">viridis</option>
                 <option value="parula">parula</option>
                 <option value="hsv">hsv</option>
                 <option value="jet">jet</option>
                 <option value="bwr">bwr</option>
                 <option value="bgr">bgr</option>
                 <option value="hot">hot</option>
                 <option value="giraffe">giraffe</option>
               </select>
               <p>
               <input type="checkbox" id="cboxDark" onclick=toggleDarkness() checked="false" title="toggle darkness">
               dark background
               <input title="option to show the colorbar" onclick=toggleColorbar() type="checkbox" id="showcolorbar" checked="false">show colorbar</input>
             </p>
            </div>
           </div>
         </div> <!-- colours -->

         <!-- clipping -->
         <div class="panel panel-default">
           <div class="panel-heading">
               <a data-toggle="collapse" data-parent="#accordion" href="#collapse3">
               Clipping</a>
           </div>
           <div id="collapse3" class="panel-collapse collapse">
             <div class="panel-body">
               <input title="show clipping plane" type="checkbox" id="plotclip" onclick="plotClip()" checked>show</input>
               <input title="flip clipping side" type="checkbox" id="flipclip" checked="false">flip</input>
               <input title="check for real-time clipping" type="checkbox" id="realtime" checked="false">real-time</input>
               <div style="white-space:nowrap">
             </div>
             <div style="white-space:nowrap">
               <input style="width:150px; display: inline-block" align="left" type="range" oninput="plotClip()" id="clipalpha" name="alpha" , min="-90" max="90", step="1" value="0">
               <input style="width:150px; display: inline-block" align="right" type="range" oninput="plotClip()" id="clipbeta" name="beta" , min="-90" max="90", step="1" value="0">
             </div>
                <div style="width:100px; display: inline-block" align="left">
                  offset
                  <input type="number" oninput="plotClip()" id="clipd" name="x" min="-10000" max="10000" step=".1" VALUE="0" SIZE="1" style="width:60%">
                </div>
                <div style="width:200px; display: inline-block" align="right">
                  <button title="reset" type="button" id="resetclip" onclick="resetClip()">reset</button>
                  <button title="clip" type="button" id="clipbutton" onclick="clipRequest()">clip</button>
                </div>
             </div>
           </div>
         </div> <!-- clipping -->

         <!-- 4d controls -->
         <div class="panel panel-default">
           <div class="panel-heading">
               <a data-toggle="collapse" data-parent="#accordion" href="#collapse4">
               4d controls</a>
           </div>
           <div id="collapse4" class="panel-collapse collapse">
             <!--
              <div class="panel-body">
              <div>
                &nbsp; &nbsp;
                XY &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                XZ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                XT &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                YZ &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                YT &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                ZT
              </div>
              <input id="control4d-angleXY" type="number" min="-90" max="90" step="1" value="0">
              <input id="control4d-angleXZ" type="number" min="-90" max="90" step="1" value="0">
              <input id="control4d-angleXT" type="number" min="-90" max="90" step="1" value="0">
              <input id="control4d-angleYZ" type="number" min="-90" max="90" step="1" value="0">
              <input id="control4d-angleYT" type="number" min="-90" max="90" step="1" value="0">
              <input id="control4d-angleZT" type="number" min="-90" max="90" step="1" value="0">
             </div>            -->
             <div>
               <div position="relative" style="width:220px; display: inline-block;">
                 &nbsp;&nbsp;offset <input id="control4d-distance" type="number"min="-10000" max="10000" step=".1" VALUE="0" SIZE="1" style="width:30%">
                 &nbsp;&nbsp; plane <select name="hyperplane4d" id="hyperplaneSelect" value="T" style="width:50px; display:inline-block;">
                   <option value="X">X</option>
                   <option value="Y">Y</option>
                   <option value="Z">Z</option>
                   <option value="T" selected="selected">T</option>
                 </select>
              </div>
               <div align="right" position="relative" style="width:100px; display: inline-block;">
                 <!--<input title="check for experimental rotations" type="checkbox" id="experimental-4d" checked="false"></input>-->
                <!--<button onclick="resetSlice()">reset</button>-->
                <button onclick="sliceRequest()">apply</button>
              </div>
            </div>
           </div>
         </div> <!-- 4d controls -->
       </div>

     </div> <!-- accordian -->

     <p>
    </p>

        <!-- tree controlling plot visibilities -->
        <div id="treefrm" oncontextmenu="return false;">
          <p align="right">
          <button title="Update" type="button" id="update-tree-button" onclick="loadTree()">load</button>
          <button title="Clear" type="button" id="clearPlots" onclick="clearPlots()">clear</button>
          </p>
        </div>

      </div>

      <!-- frame holding the webgl canvas -->
      <div id="trframe", oncontextmenu="return false;">
        <canvas id="WebViewer">
          If you are seeing this, your web browser does not support the &lt;canvas&gt; element.
        </canvas>
        <div id="colorbartext_lo" class="over"></div>
        <div id="colorbartext_hi" class="over"></div>
      </div>

      <div>
    </div>

    <script type="text/javascript">
      terminal = InitTerminal();
      var term = document.getElementById("brframe");
      term.setCommandListener(listener);
      window.addEventListener("resize", resizeFrames );
      resizeFrames();
    </script>

  </body>
</html>
